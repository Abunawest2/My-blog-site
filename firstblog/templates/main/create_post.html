{% extends "main/base.html" %}
{% load static %}

{% block title %}
{% if form.instance.pk %}Edit Post{% else %}Create Post{% endif %}
{% endblock title %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/create_post.css' %}">
{% endblock css %}

{% block content %}
{{ form.media }}  <!-- This loads TinyMCE CSS and JS -->

<div class="create-post-container">
    <div class="post-form-card">
        <!-- Header -->
        <div class="form-header">
            <div class="form-icon">
                <i class="fas fa-pen-fancy"></i>
            </div>
            <h1 class="form-title">
                {% if form.instance.pk %}
                Edit Your Story
                {% else %}
                Create Your Story
                {% endif %}
            </h1>
            <p class="form-subtitle">Share your thoughts with the world</p>
        </div>

        <!-- Messages -->
        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% else %}info-circle{% endif %} me-2"></i>
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}

        <!-- Form -->
        <form method="POST" enctype="multipart/form-data" id="postForm">
            {% csrf_token %}

            <!-- Title Field -->
            <div class="form-group">
                <label for="{{ form.title.id_for_label }}" class="form-label">
                    <i class="fas fa-heading"></i>
                    Post Title
                    <span class="required-asterisk">*</span>
                </label>
                {{ form.title }}
                <div class="form-help-text">
                    <i class="fas fa-info-circle"></i>
                    <span>Choose a catchy title for your post (5-100 characters)</span>
                </div>
                {% if form.title.errors %}
                {% for error in form.title.errors %}
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
                </div>
                {% endfor %}
                {% endif %}
            </div>

            <!-- Image Upload Field -->
            <div class="form-group">
                <label for="{{ form.add_image.id_for_label }}" class="form-label">
                    <i class="fas fa-image"></i>
                    Featured Image
                    <span style="color: var(--text-light); font-weight: 400; text-transform: none;">(Optional)</span>
                </label>

                {% if form.instance.pk and form.instance.add_image %}
                <div class="existing-image-wrapper">
                    <div class="existing-image-label">
                        <i class="fas fa-image me-2"></i>
                        <span>Current Image:</span>
                    </div>
                    <div class="existing-image-preview">
                        <img src="{{ form.instance.add_image.url }}" alt="{{ form.instance.title }}">
                        <div class="existing-image-overlay">
                            <p class="mb-0">Upload a new image to replace this one</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="file-input-wrapper">
                    <label for="{{ form.add_image.id_for_label }}" class="file-input-label" id="fileLabel">
                        <div class="file-input-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="file-input-text">
                            <strong>
                                {% if form.instance.pk and form.instance.add_image %}
                                Click to upload a new image
                                {% else %}
                                Click to upload or drag and drop
                                {% endif %}
                            </strong>
                            <small>PNG, JPG, JPEG or GIF (Max 5MB)</small>
                        </div>
                    </label>
                    {{ form.add_image }}
                </div>

                <div class="image-preview" id="imagePreview">
                    <img src="" alt="Preview" id="previewImg">
                    <div class="image-preview-actions">
                        <button type="button" class="remove-image-btn" id="removeImageBtn">
                            <i class="fas fa-trash me-2"></i>Remove Image
                        </button>
                    </div>
                </div>

                {% if form.add_image.errors %}
                {% for error in form.add_image.errors %}
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
                </div>
                {% endfor %}
                {% endif %}
            </div>

            <!-- Post Content Field with TinyMCE -->
            <div class="form-group">
                <label for="{{ form.post.id_for_label }}" class="form-label">
                    <i class="fas fa-align-left"></i>
                    Post Content
                    <span class="required-asterisk">*</span>
                </label>
                {{ form.post }}
                <div class="char-counter" id="charCounter">
                    <span id="charCount">0</span> characters
                    <span class="char-min" id="charMin"></span>
                </div>
                {% if form.post.errors %}
                {% for error in form.post.errors %}
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
                </div>
                {% endfor %}
                {% endif %}
            </div>

            <!-- Action Buttons -->
            <div class="form-actions">
                <button type="submit" class="btn-submit" id="submitBtn">
                    <i class="fas fa-{% if form.instance.pk %}save{% else %}paper-plane{% endif %} me-2"></i>
                    {% if form.instance.pk %}
                    Update Post
                    {% else %}
                    Publish Post
                    {% endif %}
                </button>
                <a href="{% url 'home' %}" class="btn-cancel">
                    <i class="fas fa-times me-2"></i>
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const fileInput = document.getElementById('{{ form.add_image.id_for_label }}');
        const fileLabel = document.getElementById('fileLabel');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const removeImageBtn = document.getElementById('removeImageBtn');
        const charCounter = document.getElementById('charCounter');
        const charCount = document.getElementById('charCount');
        const charMin = document.getElementById('charMin');
        const submitBtn = document.getElementById('submitBtn');
        const postForm = document.getElementById('postForm');

        // File input change handler
        if (fileInput) {
            fileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File size must be less than 5MB');
                        fileInput.value = '';
                        return;
                    }
                    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                    if (!validTypes.includes(file.type)) {
                        alert('Please upload a valid image file (JPG, JPEG, PNG, or GIF)');
                        fileInput.value = '';
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        previewImg.src = e.target.result;
                        imagePreview.classList.add('show');
                        fileLabel.classList.add('has-file');
                        fileLabel.querySelector('strong').textContent = file.name;
                        fileLabel.querySelector('small').textContent = 'Image ready to upload';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Remove image handler
        if (removeImageBtn) {
            removeImageBtn.addEventListener('click', function () {
                fileInput.value = '';
                imagePreview.classList.remove('show');
                fileLabel.classList.remove('has-file');
                fileLabel.querySelector('strong').textContent = '{% if form.instance.pk and form.instance.add_image %}Click to upload a new image{% else %}Click to upload or drag and drop{% endif %}';
                fileLabel.querySelector('small').textContent = 'PNG, JPG, JPEG or GIF (Max 5MB)';
            });
        }

        // Character counter for TinyMCE
        function updateCharCount() {
            // Get plain text content from TinyMCE
            let content = '';
            if (typeof tinymce !== 'undefined' && tinymce.get('id_post')) {
                content = tinymce.get('id_post').getContent({ format: 'text' });
            }
            const count = content.length;
            charCount.textContent = count.toLocaleString();

            if (count < 50) {
                charMin.textContent = ` (min. 50)`;
                charMin.style.color = '#e53e3e';
            } else {
                charMin.textContent = '';
            }

            if (count > 5000) {
                charCounter.classList.add('danger');
                charCounter.classList.remove('warning');
            } else if (count > 4000) {
                charCounter.classList.add('warning');
                charCounter.classList.remove('danger');
            } else {
                charCounter.classList.remove('warning', 'danger');
            }
        }

        // Update character count when TinyMCE content changes
        if (typeof tinymce !== 'undefined') {
            // Wait for TinyMCE to initialize
            setTimeout(() => {
                const editor = tinymce.get('id_post');
                if (editor) {
                    editor.on('keyup', updateCharCount);
                    editor.on('change', updateCharCount);
                    editor.on('NodeChange', updateCharCount);
                }
                updateCharCount(); // Initial count
            }, 1000);
        }

        // Form submission handler
        if (postForm) {
            postForm.addEventListener('submit', function (e) {
                const title = document.getElementById('{{ form.title.id_for_label }}').value.trim();
                let content = '';
                
                // Get content from TinyMCE or regular textarea
                if (typeof tinymce !== 'undefined' && tinymce.get('id_post')) {
                    content = tinymce.get('id_post').getContent({ format: 'text' });
                } else {
                    content = document.getElementById('id_post').value.trim();
                }

                if (title.length < 5) {
                    e.preventDefault();
                    alert('Title must be at least 5 characters long.');
                    return;
                }

                if (content.length < 50) {
                    e.preventDefault();
                    alert('Post content must be at least 50 characters long.');
                    return;
                }

                submitBtn.classList.add('loading');
                submitBtn.disabled = true;
            });
        }

        // Drag and drop functionality (unchanged)
        if (fileLabel) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                fileLabel.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                fileLabel.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                fileLabel.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                fileLabel.style.borderColor = 'var(--primary-color)';
                fileLabel.style.background = 'rgba(102, 126, 234, 0.1)';
            }

            function unhighlight() {
                if (!fileLabel.classList.contains('has-file')) {
                    fileLabel.style.borderColor = '';
                    fileLabel.style.background = '';
                }
            }

            fileLabel.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                }
            }
        }
    });
</script>
{% endblock %}