{% extends 'main/base.html' %}
{% load static %}

{% block title %}My Dashboard{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/post_comments.css' %}">
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

{% endblock css %}

{% block content %}
<div class="dashboard-container">
  <!-- Dashboard Header -->
  <div class="dashboard-header">
    <h1><i class="fas fa-tachometer-alt me-2"></i>My Dashboard</h1>
    <p>Welcome back, {{ user.get_full_name|capfirst }}! Here's your activity overview.</p>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    
    <div class="stat-card">
      <div class="stat-icon purple">
        <i class="fas fa-file-alt"></i>
      </div>
      {% if user.is_staff %}
        <div class="stat-value">{{ total_posts }}</div>
        <div class="stat-label">Total Posts</div>
    
      {% else %}
        <div class="stat-value">{{total_posts}}</div>
        <div class="stat-label">Total Viewed Post</div>
      {% endif %}
    </div>
    
    

    <div class="stat-card">
      <div class="stat-icon blue">
        <i class="fas fa-comments"></i>
      </div>
      <div class="stat-value">{{ total_comments }}</div>
      <div class="stat-label">Comments Made</div>
    </div>

    <div class="stat-card">
      <div class="stat-icon green">
        <i class="fas fa-heart"></i>
      </div>
      <div class="stat-value">{{ total_comment_likes }}</div>
      <div class="stat-label">Comment Likes Received</div>
    </div>
    {% if user.is_staff %}
    <div class="stat-card">
      <div class="stat-icon green">
        <i class="fas fa-heart"></i>
      </div>
      
        <div class="stat-value">{{ total_post_likes }}</div>
        <div class="stat-label">Post Likes Received</div>
    </div>
    {% endif %}
  </div>

  <!-- My Posts Section -->
<div class="dashboard-section">
    {% if not user.is_staff %}
    <!-- Recently Viewed Posts for Regular Users -->
    <div class="section-header">
        <h2 class="section-title">
            <i class="fas fa-file-alt"></i>
            Recently Viewed Posts
        </h2>
    </div>

    {% if recently_viewed %}
    {% for view in recently_viewed %}
    <div class="post-list-item">
        <div class="post-list-title">
            <a href="{% url 'post_detail' view.post.pk %}">{{ view.post.title }}</a>
        </div>
        <div class="post-list-meta">
            <span>
                <i class="fas fa-calendar"></i>
                {{ view.post.date_created|date:"M d, Y" }}
            </span>
            <span>
                <i class="fas fa-comment"></i>
                {{ view.post.get_comment_count }} comment{{ view.post.get_comment_count|pluralize }}
            </span>
            <span>
                <i class="fas fa-eye"></i>
                Viewed {{ view.viewed_at|timesince }} ago
            </span>
            {% if view.post.date_updated != view.post.date_created %}
            <span>
                <i class="fas fa-edit"></i>
                Updated {{ view.post.date_updated|timesince }} ago
            </span>
            {% endif %}
        </div>
        <div class="post-list-actions">
            <a href="{% url 'post_detail' view.post.pk %}" class="post-action-btn">
                <i class="fas fa-eye"></i>
                View Again
            </a>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="empty-state">
        <i class="fas fa-file-alt"></i>
        <p>Go to the Homepage and Read the latest topic on Tech and Business.</p>
        <a href="{% url 'home' %}" class="btn btn-primary mt-3">
            <i class="fas fa-home me-2"></i>Browse Posts
        </a>
    </div>
    {% endif %}

    {% else %}
    <!-- My Posts for Staff Users -->
    <div class="section-header">
        <h2 class="section-title">
            <i class="fas fa-file-alt"></i>
            My Posts
        </h2>
        <a href="{% url 'create_post' %}" class="create-post-btn">
            <i class="fas fa-plus"></i>
            Create New Post
        </a>
    </div>

    {% if posts %}
    {% for post in posts %}
    <div class="post-list-item">
        <div class="post-list-title">
            <a href="{% url 'post_detail' post.pk %}">{{ post.title }}</a>
        </div>
        <div class="post-list-meta">
            <span>
                <i class="fas fa-calendar"></i>
                {{ post.date_created|date:"M d, Y" }}
            </span>
            <span>
                <i class="fas fa-comment"></i>
                {{ post.get_comment_count }} comment{{ post.get_comment_count|pluralize }}
            </span>
            {% if post.date_updated != post.date_created %}
            <span>
                <i class="fas fa-edit"></i>
                Updated {{ post.date_updated|timesince }} ago
            </span>
            {% endif %}
        </div>
        <div class="post-list-actions">
            <a href="{% url 'post_detail' post.pk %}" class="post-action-btn">
                <i class="fas fa-eye"></i>
                View
            </a>
            <a href="{% url 'update_post' post.pk %}" class="post-action-btn">
                <i class="fas fa-edit"></i>
                Edit
            </a>
            <a href="{% url 'delete_post' post.pk %}" class="post-action-btn danger">
                <i class="fas fa-trash"></i>
                Delete
            </a>
        </div>
    </div>
    {% endfor %}

    <!-- Pagination -->
    {% if posts.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if posts.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ posts.previous_page_number }}">Previous</a>
            </li>
            {% endif %}

            {% for num in posts.paginator.page_range %}
            {% if posts.number == num %}
            <li class="page-item active">
                <span class="page-link">{{ num }}</span>
            </li>
            {% else %}
            <li class="page-item">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
            {% endif %}
            {% endfor %}

            {% if posts.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ posts.next_page_number }}">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    {% else %}
    <div class="empty-state">
        <i class="fas fa-file-alt"></i>
        <p>You haven't created any posts yet.</p>
        <a href="{% url 'create_post' %}" class="btn btn-primary mt-3">
            <i class="fas fa-plus me-2"></i>Create Your First Post
        </a>
    </div>
    {% endif %}
    {% endif %}
</div>

  <!-- Recent Comments Section -->
  <div class="dashboard-section">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-comments"></i>
        Recent Comments
      </h2>
    </div>

    {% if recent_comments %}
    {% for comment in recent_comments %}
    <div class="comment-list-item">
      <a href="{% url 'post_detail' comment.post.pk %}" class="comment-post-ref">
        <i class="fas fa-link me-1"></i>
        On: {{ comment.post.title }}
      </a>
      <div class="comment-text">
        {{ comment.text|truncatewords:30 }}
      </div>
      <div class="comment-meta">
        <i class="fas fa-clock me-1"></i>
        {{ comment.date_created|timesince }} ago
        {% if comment.likes_count > 0 %}
        <i class="fas fa-heart ms-3 me-1"></i>
        {{ comment.likes_count }} like{{ comment.likes_count|pluralize }}
        {% endif %}
      </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="empty-state">
      <i class="fas fa-comments"></i>
      <p>You haven't made any comments yet.</p>
      <a href="{% url 'home' %}" class="btn btn-primary mt-3">
        <i class="fas fa-home me-2"></i>Browse Posts
      </a>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}